<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Linux version 4.9.30">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Philip Elson">
    <link rel="icon" href="https://pelson.github.io/theme/images/favicon.ico">
    <title>
      Building a matrix of conda distributions with conda-build-all by Phil Elson - Software | Science | Python
    </title><!-- Bootstrap core CSS -->
    <link href="https://pelson.github.io/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet"><!-- Custom styles for this template -->
    <link href="https://pelson.github.io/theme/css/style.css" rel="stylesheet">
    <link href="https://pelson.github.io/" type="application/atom+xml" rel="alternate" title="Phil Elson - Software | Science | Python ATOM Feed">
    <link rel="stylesheet" href="https://pelson.github.io/theme/font-awesome/css/font-awesome.min.css">
    <link href="//fonts.googleapis.com/css?family=Pacifico" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://pelson.github.io/theme/css/pygments-default.css">
    <link rel="stylesheet" href="https://pelson.github.io/theme/css/notebook-styling.css">
  </head><!-- NAVBAR ================================================== -->
  <body>
    <div class="container-fullwidth">
      <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="row">
          <div id="banner" class="col-md-3 shrinker">
            <div>
              <p class="by-phil">
                <a href="https://pelson.github.io">Phil Elson</a>
              </p>
            </div>
          </div>
          <div class="col-md-6 text-center">
            <div class="brand-icons">
              <div id="nav-sci" class="col-xs-4">
                <a href="https://pelson.github.io"><i class="fa fa-icon fa-fw fa-flask"></i>
                <h2>
                  Science
                </h2></a>
              </div>
              <div id="nav-software" class="col-xs-4">
                <a href="https://pelson.github.io"><i class="nav-icon fa fa-code"></i>
                <h2>
                  Software
                </h2></a>
              </div>
              <div id="nav-oss" class="col-xs-4">
                <a href="https://pelson.github.io"><img src="https://pelson.github.io/theme/images/osi_white.png" alt="Open Source">
                <h2>
                  Open source
                </h2></a>
              </div>
            </div>
          </div>
          <div class="col-md-3 nav-toggle">
            <i class="fa fa-bars"></i>
          </div>
        </div>
        <script>
        var navbar_toggled = false;
        </script>
        <div class="actual-navbar shrink">
          <ul class="nav navbar-nav nav-pills">
            <li class="hidden-xs clearfix">
              <a href="https://pelson.github.io"><i class="fa fa-fw fa-home"></i>Home</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/articles/"><i class="fa fa-fw fa-file-o"></i>Articles</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/announce/"><i class="fa fa-fw fa-bullhorn"></i>Announcements</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/field-notes/"><i class="fa fa-fw fa-map-o"></i>&nbsp;Field notes</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/hints-n-tips/"><i class="fa fa-fw fa-list-ul"></i>Hints &amp; Tips</a>
            </li>
            <li class="hidden-xs dropdown clearfix">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-fw fa-clock-o"></i>Recent <span class="caret"></span></a>
              <ul class="dropdown-menu dropdown-menu-right">
                <li>
                  <a href="https://pelson.github.io/2019/cf_units_tex/">cf-units get (La)TeX unit repr... and a UDUNITS-2 parser to boot</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2018/LFRic_containment/">Investigating containment testing on LFRic's cubedsphere</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2018/coast-path/">Analysing walks on the South West Coast Path</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2018/hints/search-and-replace/">Recursive search and replace</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2017/hints/applicationize/">Creating an application for a website on OSX</a>
                </li>
                <li class="nav-divider"></li>
                <li>
                  <a href="https://pelson.github.io/archives.html">See full archive (19)</a>
                </li>
              </ul>
            </li>
            <li class="hidden-xs dropdown clearfix">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-fw fa-tags"></i>Tags <span class="caret"></span></a>
              <ul class="dropdown-menu dropdown-menu-right">
                <li>
                  <a href="https://pelson.github.io/tag/biggus/">biggus (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/cartopy/">cartopy (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/cf-units/">cf-units (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/cla/">CLA (1)</a>
                </li>
                <li class="active">
                  <a href="https://pelson.github.io/tag/conda/">conda (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/docker/">docker (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/fiona/">fiona (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/folium/">folium (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/fonts/">fonts (4)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/fuse/">FUSE (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/github/">GitHub (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/heroku/">heroku (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/lfric/">LFRic (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/matplotlib/">matplotlib (4)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/python/">Python (10)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/shapely/">shapely (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/tornado/">tornado (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/udunits-2/">UDUNITS-2 (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/voluminous-data/">voluminous data (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/xarray/">xarray (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/xkcd/">XKCD (4)</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <div class="navbar-spacer"></div>
    </div>
    <div class="container">
      <h2 id="single">
        Building a matrix of conda distributions with conda-build-all
      </h2><img class="article-image" src="https://pelson.github.io/images/conda_build_all/construction.gif" alt="">
      <div class="date entry-info">
        <div style="float: left; padding: 0.5em 1em 0.5em 0em;">
          <time datetime="2015-12-09T12:00:00+00:00" class="icon"></time>
          <div class="time-icon">
            <p class="year">
              2015
            </p>
            <p class="month">
              December
            </p><span class="day">9</span>
          </div>
        </div>
        <p>
          Tags: <a href="https://pelson.github.io/tag/conda/">conda (2)</a>
        </p>
      </div>
      <div class="entry">
        <p>
          Introducing <code>conda-build-all</code>, a tool which extends <code>conda-build</code> to provide powerful build matrix capabilities.
        </p>
        <p>
          Repositories such as <a href="https://github.com/ioos/conda-recipes">conda-forge/stages-recipes</a>, <a href="https://github.com/SciTools/conda-recipes-scitools">SciTools/conda-recipes-scitools</a> and <a href="https://github.com/ioos/conda-recipes">ioos/conda-recipes</a> exist to provide a set of conda recipes, and ultimately, channels from which users can access the product of <code>conda-build</code>-ing those recipes. The build phase of all of these repositories looks very similar: a tool (ObviousCI) computes the build matrix, builds those distributions which haven't already been built, and then uploads them to their respective channels. The functionality is tried and tested, and has been powering these repositories for over a year with huge success, however, I recently had need to use this functionality without wanting to upload the built distributions to <a href="http://conda.anaconda.org">conda.anaconda.org</a> and found the tool didn't <em>quite</em> fit the bill. Additionally, having originally cobbled together ObviousCI with string and sticky-tape to prove the concept of a continuously integrated repo of recipes, I didn't have huge confidence in its ability to function between python/conda/conda-build upgrades.
        </p>
        <p>
          As a result, I have re-factored the build part of ObviousCI into a general purpose library which can now be used for the original "conda recipe repository" use-case as much as it can for the ad-hoc "just build this" use-case. Critically, the most significant part of this re-factoring was adding a huge array of unit and integration tests which can be used to ensure expected behaviour is unchanged through future dependency version upgrades.
        </p>
        <p>
          The new CLI is <code>conda-build-all</code> (BSD license) and is developed at <a href="https://github.com/SciTools/conda-build-all">SciTools/conda-build-all</a>.
        </p>
        <h3>
          The build matrix
        </h3>
        <p>
          So what does a build matrix actually look like? Let's jump in at the deep-end and look at a package which has a NumPy C-API dependency. Whilst NumPy's ABI is (intended to be) <a href="http://stackoverflow.com/a/18369312/741316">forward-compatible</a>, in practice it is safer to compile against a specific version and "pin" the distribution to that version. Essentially, that means we need to build our recipe N times, where N is the number of NumPy versions we wish to support. Of course, the same is true for Python itself, leading to a permutation problem of up to <code>NxM</code> builds (N: number of supported NumPy versions; M: number of supported Python versions).
        </p>
        <p>
          The current conda recipe form for such a package looks like:
        </p>
        <div class="highlight">
          <pre>
<span></span><span class="kd">package</span><span class="o">:</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">my_library</span>
    <span class="n">version</span><span class="o">:</span> <span class="mf">1.0</span>
<span class="n">requirements</span><span class="o">:</span>
    <span class="n">build</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">python</span>
        <span class="o">-</span> <span class="n">numpy</span> <span class="n">x</span><span class="o">.</span><span class="na">x</span>
    <span class="n">run</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">python</span>
        <span class="o">-</span> <span class="n">numpy</span> <span class="n">x</span><span class="o">.</span><span class="na">x</span>
</pre>
        </div>
        <p>
          Whilst I believe there is <a href="https://github.com/conda/conda-build/pull/650">room for improvement</a> in the recipe definition, it is still pretty easy to define a complex set of build- and run-time dependencies.
        </p>
        <p>
          With the existing <code>conda-build</code> tool, should we want to build this for Python 2.7, 3.4 and 3.5, and against NumPy 1.9 and 1.10 (the latest versions of these libraries at the time of writing), things can get a little tedious:
        </p>
        <div class="highlight">
          <pre>
<span></span>CONDA_PY=27 CONDA_NPY=19 conda build my_library
CONDA_PY=34 CONDA_NPY=19 conda build my_library
CONDA_PY=35 CONDA_NPY=19 conda build my_library
CONDA_PY=27 CONDA_NPY=110 conda build my_library
CONDA_PY=34 CONDA_NPY=110 conda build my_library
CONDA_PY=35 CONDA_NPY=110 conda build my_library
</pre>
        </div>
        <p>
          With <code>conda-build-all</code> the special environment variables are taken care of for you (and importantly there is future scope to generalise beyond Python &amp; NumPy) and a build matrix is computed:
        </p>
        <div class="highlight">
          <pre>
<span></span>$ conda-build-all my_library
Resolving distributions from <span class="m">1</span> recipes... 
Computed that there are <span class="m">7</span> distributions from the <span class="m">1</span> recipes:
Resolved dependencies, will be built in the following order: 
    my_library-1.0-np19py26_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
</pre>
        </div>
        <p>
          Notice how this command is not conceptually equivalent to the original <code>conda-build</code> calls as I have not asked for particular versions to build against. <code>conda-build-all</code> has chosen the top two major versions and within those, the top two minor versions of the packages which require "pinning". Unfortunately, that included Python 2.6, which I didn't really want - to resolve that, we can add extra conditions to our build:
        </p>
        <div class="highlight">
          <pre>
<span></span>$ conda-build-all my_library --matrix-conditions <span class="s2">"python &gt;=2.7"</span>
Fetching package metadata: ........
Resolving distributions from <span class="m">1</span> recipes... 
Computed that there are <span class="m">6</span> distributions from the <span class="m">1</span> recipes:
Resolved dependencies, will be built in the following order: 
    my_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py34_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
</pre>
        </div>
        <p>
          We now have functionally equivalent behaviour that will move forwards as new Python and NumPy versions become available.
        </p>
        <h3>
          Building multiple recipes in a single call
        </h3>
        <p>
          <code>conda-build-all</code> knows what a conda recipe looks like, and will traverse the directories you give it to look for things to build.
        </p>
        <p>
          Supposing we have a directory of recipes which we wish to build, such as the following:
        </p>
        <div class="highlight">
          <pre>
<span></span>$ find * -name meta.yaml -exec sh -c <span class="s2">"echo RECIPE: {}; cat {}; echo"</span> <span class="se">\;</span>
RECIPE: my_recipes_directory/my_library/meta.yaml
package:
    name: my_library
    version: <span class="m">1</span>.0
requirements:
    build:
        - python
        - numpy x.x
    run:
        - python
        - numpy x.x

RECIPE: my_recipes_directory/my_other_library/meta.yaml
package:
    name: my_other_library
    version: <span class="m">1</span>.0
requirements:
    build:
        - python
        - numpy x.x
    run:
        - python
        - numpy x.x
</pre>
        </div>
        <p>
          We can simply call <code>conda-build-all</code> on the directory of recipes to have them built appropriately:
        </p>
        <div class="highlight">
          <pre>
<span></span>$ conda-build-all my_recipes_directory --matrix-conditions <span class="s2">"python 2.7.*|3.5.*"</span>
Fetching package metadata: ........
Resolving distributions from <span class="m">2</span> recipes... 
Computed that there are <span class="m">8</span> distributions from the <span class="m">2</span> recipes:
Resolved dependencies, will be built in the following order: 
    my_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np110py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np19py27_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np110py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
    my_other_library-1.0-np19py35_0 <span class="o">(</span>will be built: True<span class="o">)</span>
</pre>
        </div>
        <p>
          This functionality becomes invaluable when we wish to build many packages, such is the case for the conda-recipes repositories mentioned earlier.
        </p>
        <h3>
          Only building the missing distributions
        </h3>
        <p>
          The build matrix is supremely useful, but it does come at the cost of the extra time needed to build the many distributions. With repositories full of recipes, it is easy to come to hundreds of build matrix items. If we want to be able to run <code>conda-build-all</code> on a regular basis, we can't reasonably expect to build each of those items each time. Therefore, <code>conda-build-all</code> has the ability to inspect various locations to determine if a distribution has already been built. In fact, the default behaviour is to inspect the local conda-build directory to determine if a distribution has already been built locally. Other options include the ability to inspect conda channels as well as arbitrary local directories. Supposing we wanted the <code>pelson/channel/testing</code> channel to have all of the built distributions from <code>my_recipes_directory</code>, we can use <code>conda-build-all</code> to good effect:
        </p>
        <div class="highlight">
          <pre>
<span></span>conda-build-all my_recipes_directory/ --matrix-conditions "python 2.7.*|3.5.*" \
    --inspect-channels "pelson/channel/testing" \
    --upload-channels "pelson/channel/testing" \
    --no-inspect-conda-bld-directory
</pre>
        </div>
        <h3>
          Summary
        </h3>
        <p>
          <code>conda-build-all</code> is a tool which builds on top of <code>conda-build</code> to give powerful build-matrix options when building conda distributions. It has come from <code>ObviousCI</code>, whose primary objective was to simplify the build and upload of many recipes in a Continuous Integration environment. In migrating the code base from <code>ObviousCI</code> several new test strategies have been developed - making <code>conda-build-all</code> easier to maintain, and giving rise to the possibility of improving the <code>conda</code> and <code>conda-build</code> test suites themselves.
        </p>
      </div>
      <hr>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      var disqus_shortname = "pelson";
      var disqus_identifier = "conda_build_all";

      (function() {
      var dsq = document.createElement("script");
      dsq.type = "text/javascript";
      dsq.async = true;
      dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
      (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
      })();
      </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- /END THE FEATURETTES -->
      <div class="clearfix"></div>
      <hr class="featurette-divider">
      <!-- FOOTER -->
      <footer>
        <p class="pull-right">
          <a href="#">Back to top</a>
        </p>
        <p>
          © 2017 Phil Elson · <a href="https://pelson.github.io#">About</a> · <a href="https://pelson.github.io#contact">Contact</a> · <a href="https://pelson.github.io/feeds/atom.xml"><i class="fa fa-fw fa-rss-square"></i>RSS</a>
        </p>
      </footer>
    </div><!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://pelson.github.io/theme/jquery.min.js">
    </script> 
    <script src="https://pelson.github.io/theme/bootstrap.min.js">
    </script> 
    <script src="https://pelson.github.io/theme/js/scroll.js">
    </script> 
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29774503-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
