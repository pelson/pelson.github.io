<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Mac OS X version 4.9.30">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Philip Elson">
    <link rel="icon" href="https://pelson.github.io/theme/images/favicon.ico">
    <title>
      Mounting a FUSE filesystem in Heroku by Phil Elson - Software | Science | Python
    </title><!-- Bootstrap core CSS -->
    <link href="https://pelson.github.io/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet"><!-- Custom styles for this template -->
    <link href="https://pelson.github.io/theme/css/style.css" rel="stylesheet">
    <link href="https://pelson.github.io/" type="application/atom+xml" rel="alternate" title="Phil Elson - Software | Science | Python ATOM Feed">
    <link rel="stylesheet" href="https://pelson.github.io/theme/font-awesome/css/font-awesome.min.css">
    <link href="//fonts.googleapis.com/css?family=Pacifico" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://pelson.github.io/theme/css/pygments-default.css">
    <link rel="stylesheet" href="https://pelson.github.io/theme/css/notebook-styling.css">
  </head><!-- NAVBAR ================================================== -->
  <body>
    <div class="container-fullwidth">
      <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="row">
          <div id="banner" class="col-md-3 shrinker">
            <div>
              <p class="by-phil">
                <a href="https://pelson.github.io">Phil Elson</a>
              </p>
            </div>
          </div>
          <div class="col-md-6 text-center">
            <div class="brand-icons">
              <div id="nav-sci" class="col-xs-4">
                <a href="https://pelson.github.io"><i class="fa fa-icon fa-fw fa-flask"></i>
                <h2>
                  Science
                </h2></a>
              </div>
              <div id="nav-software" class="col-xs-4">
                <a href="https://pelson.github.io"><i class="nav-icon fa fa-code"></i>
                <h2>
                  Software
                </h2></a>
              </div>
              <div id="nav-oss" class="col-xs-4">
                <a href="https://pelson.github.io"><img src="https://pelson.github.io/theme/images/osi_white.png" alt="Open Source">
                <h2>
                  Open source
                </h2></a>
              </div>
            </div>
          </div>
          <div class="col-md-3 nav-toggle">
            <i class="fa fa-bars"></i>
          </div>
        </div>
        <script>
        var navbar_toggled = false;
        </script>
        <div class="actual-navbar shrink">
          <ul class="nav navbar-nav nav-pills">
            <li class="hidden-xs clearfix">
              <a href="https://pelson.github.io"><i class="fa fa-fw fa-home"></i>Home</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/articles/"><i class="fa fa-fw fa-file-o"></i>Articles</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/announce/"><i class="fa fa-fw fa-bullhorn"></i>Announcements</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/field-notes/"><i class="fa fa-fw fa-map-o"></i>&nbsp;Field notes</a>
            </li>
            <li class=" clearfix">
              <a href="https://pelson.github.io/hints-n-tips/"><i class="fa fa-fw fa-list-ul"></i>Hints &amp; Tips</a>
            </li>
            <li class="hidden-xs dropdown clearfix">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-fw fa-clock-o"></i>Recent <span class="caret"></span></a>
              <ul class="dropdown-menu dropdown-menu-right">
                <li>
                  <a href="https://pelson.github.io/2018/LFRic_containment/">Investigating containment testing on LFRic's cubedsphere</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2018/coast-path/">Analysing walks on the South West Coast Path</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2018/hints/search-and-replace/">Recursive search and replcace</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2017/hints/npm_link/">Installing a package from source using npm</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/2017/hints/applicationize/">Creating an application for a website on OSX</a>
                </li>
                <li class="nav-divider"></li>
                <li>
                  <a href="https://pelson.github.io/archives.html">See full archive (19)</a>
                </li>
              </ul>
            </li>
            <li class="hidden-xs dropdown clearfix">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-fw fa-tags"></i>Tags <span class="caret"></span></a>
              <ul class="dropdown-menu dropdown-menu-right">
                <li>
                  <a href="https://pelson.github.io/tag/biggus/">biggus (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/cartopy/">cartopy (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/cla/">CLA (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/conda/">conda (2)</a>
                </li>
                <li class="active">
                  <a href="https://pelson.github.io/tag/docker/">docker (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/fiona/">fiona (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/folium/">folium (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/fonts/">fonts (4)</a>
                </li>
                <li class="active">
                  <a href="https://pelson.github.io/tag/fuse/">FUSE (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/github/">GitHub (1)</a>
                </li>
                <li class="active">
                  <a href="https://pelson.github.io/tag/heroku/">heroku (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/lfric/">LFRic (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/matplotlib/">matplotlib (4)</a>
                </li>
                <li class="active">
                  <a href="https://pelson.github.io/tag/python/">Python (10)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/shapely/">shapely (2)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/tornado/">tornado (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/voluminous-data/">voluminous data (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/xarray/">xarray (1)</a>
                </li>
                <li>
                  <a href="https://pelson.github.io/tag/xkcd/">XKCD (4)</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <div class="navbar-spacer"></div>
    </div>
    <div class="container">
      <h2 id="single">
        Mounting a FUSE filesystem in Heroku
      </h2>
      <div class="date entry-info">
        <div style="float: left; padding: 0.5em 1em 0.5em 0em;">
          <time datetime="2017-02-06T00:00:00+00:00" class="icon"></time>
          <div class="time-icon">
            <p class="year">
              2017
            </p>
            <p class="month">
              February
            </p><span class="day">6</span>
          </div>
        </div>
        <p>
          Tags: <a href="https://pelson.github.io/tag/docker/">docker (1)</a>, <a href="https://pelson.github.io/tag/fuse/">FUSE (1)</a>, <a href="https://pelson.github.io/tag/heroku/">Heroku (2)</a>, <a href="https://pelson.github.io/tag/python/">python (10)</a>
        </p>
      </div>
      <div class="entry">
        <p>
          This evening I'm going to take a different approach to how I would normaly blog.
        </p>
        <p>
          Rather than reporting the results of a technical investigation or highlighting a new/shiny package, I wanted to paint a realistic picture of the technical exploration process.
        </p>
        <p>
          As it happens, this particular investigation consumed a couple of hours and appears to have drawn an unsucessful result. Despite this, the learnings are invaluable as they will be directly and immediately applicable to other areas of my work.
        </p>
        <h2>
          The problem
        </h2>
        <p>
          I run a number of services on Heroku. It's an amazing platform for rapid prototyping of (mostly web) applications. The beauty of Heroku is the ease of deployment as well as its availablity, scalability and cost.
        </p>
        <p>
          I have one particular application on Heroku that draws statistics from a moderately sized, slow paced, filestore. Unfortunately, since all storage on Heroku is ephermeral, that means I must fetch the data at least once every 24 hours (when Heroku restarts the container) to recompute my statistics (which are cached for application performance). Fetching the data is a costly operation, and I'd rather avoid it if possible.
        </p>
        <p>
          Instead of fetching the data on a daily basis, I'd like to have a third-party filestore that can be used from within the Heroku application for its statistics generation. I'd also like to use the store for the cache (which itself can be mem-cached/cached to the ephemeral Heroku disk). In order to invalidate the cache I will want an efficient means of getting a checksum or pertinent fstat info. The detail here isn't important, suffice to say I'd just like <em>some</em> persistence my source data for an otherwise stateless application.
        </p>
        <h2>
          The proposal
        </h2>
        <p>
          Having read a little in the past about libfuse, it seemed that using FUSE to mount a networked resource would be a great match for the problem. Because I have a few GB lying around on Dropbox, and there appeared to be a python based Dropbox-fuse client (ff4d), I decided to investigate the feasibility of mounting my Dropbox directory inside my Heroku application. Other options would have worked just as a well, including an S3 bucket (with s3fs-fuse), or a direct ssh connection (with sshfs).
        </p>
        <p>
          I had also read a little bit about Heroku's new Docker container registry and runtime environment (https://devcenter.heroku.com/articles/container-registry-and-runtime) and thought this would be a great opportunity to shorten the deployment cycle.
        </p>
        <h2>
          The findings
        </h2>
        <h3>
          Mounting a dropbox directory through ff4d
        </h3>
        <p>
          The first step is to get FUSE up-and-running on my own machine (OSX). libfuse is the first thing in a while that I've not been able to get hold of through conda, so I ended up dusting off my homebrew installation and going through a pretty heafty update. Once complete I tried:
        </p>
        <div class="highlight">
          <pre>
<span></span>brew install libfuse
</pre>
        </div>
        <p>
          With no success. Turns out that osxfuse is a thing, and so I:
        </p>
        <div class="highlight">
          <pre>
<span></span>brew install osxfuse
</pre>
        </div>
        <p>
          Again, no luck, but homebrew does point me in the direction of a cask version (pre-compiled, rather than building it from source on my machine). I'm pretty keen to get going with this, so I go ahead and install the casked version:
        </p>
        <div class="highlight">
          <pre>
<span></span>brew install Caskroom/cask/osxfuse
</pre>
        </div>
        <p>
          After a short wait, the result is positive, and it looks like I have a local FUSE installation.
        </p>
        <p>
          Next, I want to try it out. Rather than choose to do somethign simple, I go straight for the jugular and try to get a dropbox FUSE mount working. I clone https://github.com/realriot/ff4d and get myself set up with a legacy python installation (in a clean environment named "ff4d_py2":
        </p>
        <div class="highlight">
          <pre>
<span></span>conda create -n ff4d_py2 python=2 pip
source activate ff4d_py2
pip install dropbox
</pre>
        </div>
        <p>
          I take a note of the dependency on a legacy version of Python, and vow to submit a merge request making the codebase python (3) compatible should I want to turn this proof-of-concept into something more.
        </p>
        <p>
          Next, I create a "Dropbox API" -&gt; "Full Dropbox" application on https://www.dropbox.com/developers/apps/create and run:
        </p>
        <div class="highlight">
          <pre>
<span></span>python getDropboxAccessToken.py
</pre>
        </div>
        <p>
          I follow on the on-screen prompts and am eventually rewarded with an OAuth token that I store securely. With my token in hand:
        </p>
        <div class="highlight">
          <pre>
<span></span>mkdir foobar
python ff4d.py  ./foobar -ap &lt;my_token&gt;
</pre>
        </div>
        <p>
          Gives me a directory called foobar containing my dropbox content, and reminds me that I can delete nearly a GB of images that were shared with colleagues on my dropbox account. As I delete the files (<code>rm -rf ./foobar/my_image_directory</code>) I'm aware that there are a number of 404 error type messages being logged by ff4d.py - I take a note that there is something that needs deeper investigation here.
        </p>
        <p>
          So there we have it, a locally mounted dropbox folder sitting on my OSX machine, thanks to ff4d. Now, I want to create a webapp that can show the contents of my directory (as a proof-of-concept), and to replicate this setup in a docker container, and then ultimately in a Heroku web app deployment.
        </p>
        <h3>
          Creating the webapp
        </h3>
        <p>
          I'm a big fan of <a href="http://www.tornadoweb.org/en/stable/">tornado</a>, and since the application that could benefit from access to my dropbox mount is also using tornado I put together a quick web-app to browse the directory.
        </p>
        <p>
          I'd assumed that creating a http handler that allows directory listing would be built-in to tornado, but it appears not, so I ended up re-using code from https://github.com/imom0/SimpleTornadoServer/blob/master/SimpleTornadoServer.py (BSD-3) to allow me to navigate my directories from within the webapp.
        </p>
        <p>
          In order for my webapp and ff4d mount to be run on the same process within Heroku (not the only option - it is easy enough to create new processes on Heroku, I just like the ability to control them all from a single process) I need to get the webapp to mount the dropbox directory itself. Since mounting through ff4d is blocking, I am going to need to run one 2 IOLoops, one on the main thread (for tornado) and the other in a ThreadPoolExecutor managed thread (for ff4d).
        </p>
        <p>
          Getting another thread to run a blocking script whilst still running a responsive tornado main IOLoop thread is something I have done a few times now. In other situations I have wanted to commuicate through Kafka ((example)[http://stackoverflow.com/a/40602866/741316]) in my tornado application, and in another application I wanted the ability to (optionally) spawn a Dask scheduler, workers and client. Truth be told, in most of these situations processes are a better choice, but I digress.
        </p>
        <p>
          Getting a tornado webapp to run a blocking process in another thread is surprisingly easy. We need a ThreadPool, and an asyncronous function that can run on the main thread:
        </p>
        <div class="highlight">
          <pre>
<span></span>@tornado.gen.coroutine
def async(executor, function, *args, **kwargs):
    yield executor.submit(function, *args, **kwargs)

thread_pool = ThreadPoolExecutor(1)
tornado.ioloop.IOLoop.current().spawn_callback(async, thread_pool, start_mount, mount_dir=mount_dir)
</pre>
        </div>
        <p>
          The function itself is fairly trivial, and simply spawns a sub-process which mounts my dropbox directory:
        </p>
        <div class="highlight">
          <pre>
<span></span>def start_mount(mount_dir):
    dropbox_token = os.environ.get('DROPBOX_TOKEN')
    if not os.path.exists(mount_dir):
        os.mkdir(mount_dir)
    subprocess.check_call([sys.executable, 'ff4d.py', mount_dir, '-ap', dropbox_token])
</pre>
        </div>
        <p>
          With all of this in place, I'm able to fire up my tornado webapp, and navigate my dropbox content from within the browser.
        </p>
        <p>
          The complete code can be found at https://github.com/pelson/heroku-with-dropbox-mount.
        </p>
        <h3>
          Build &amp; deploy with Docker
        </h3>
        <p>
          Groundwork complete, we now want to put some scaffolding around our proof-of-concept so that we can easily test and deploy the application on Heroku.
        </p>
        <p>
          As I mentioned at the beginning, I recently read-up about the new docker based Heroku deployment option, and want to give it a shot. Since I'm on OSX, I fire up docker-machine (needed an update) and get started with writing my Dockerfile.
        </p>
        <p>
          I was aware of Continuum's Docker images, and so reached for that as the base image, before extending to my requirements. There is nothing earth-shattering about the Dockerfile I produced (available at https://github.com/pelson/heroku-with-dropbox-mount), and my build -&gt; test workflow looks like:
        </p>
        <div class="highlight">
          <pre>
<span></span>docker build --tag=docker_webapp_test
</pre>
        </div>
        <p>
          and
        </p>
        <div class="highlight">
          <pre>
<span></span>docker run -p 5000:5000 -e PORT=5000 -e DROPBOX_TOKEN=&lt;my_token&gt; -t -i docker_webapp_test
</pre>
        </div>
        <p>
          As mentioned, I'm using docker-machine to run docker - it essentially manages a VirtualBox machine to run a suitable host OS for docker. This means that even though the the port was forwarded in my <code>docker run</code> call, it won't be visible to me on localhost. To find out what IP my machine is running on, we can call <code>docker-machine ip &lt;machine_name&gt;</code>. It is this address (+":5000") that I use to see the webapp in my browser.
        </p>
        <p>
          Things are starting to come together nicely, except the mount of my device was failing with messages similar to:
        </p>
        <div class="highlight">
          <pre>
<span></span>Starting FUSE...
fuse: failed to open /dev/fuse: Operation not permitted
[ERROR] Failed to start FUSE... (Traceback (most recent call last):
</pre>
        </div>
        <p>
          It turns out that we need elevated priveledges to mount a FUSE device within docker. Adding <code>--cap-add SYS_ADMIN</code> and <code>--device /dev/fuse</code> to docker should be enough (though it appears there was once a bug in docker that meant the container needed to be run with <em>full</em> priveledges). I make a note of this as a potential problem for our Heroku deployment.
        </p>
        <p>
          Finally, I'm able to launch my docker image and navigate my dropbox content through my web app. The final step is to push this image to Heroku:
        </p>
        <div class="highlight">
          <pre>
<span></span>heroku container:push web
</pre>
        </div>
        <p>
          After a considerable amount of time waiting for all of the image layers to upload I get an error in my heroku logs. Simply changing CMD to something that should obviously work (<code>ls -ltr</code>) I get a similar error:
        </p>
        <div class="highlight">
          <pre>
<span></span>2017-02-07T11:13:48.755363+00:00 heroku[web.1]: State changed from crashed to starting
2017-02-07T11:13:56.607038+00:00 heroku[web.1]: Starting process with command `/bin/sh -c \"ls\ -ltr\"`
2017-02-07T11:13:59.043845+00:00 app[web.1]: Error: No such file or directory
</pre>
        </div>
        <p>
          It may be a red-herring, but the command escaping looks a little off. I iterate further with just <code>ls</code> as the CMD, but get the same error. Iterating takes about 30s, so a trial and error approach to solving the problem is proving tedious - I would love to be able to reproduce the issue locally to shorten the loop. I try removing the quotes within the Dockerfile's CMD section and I ensure that PATH is correctly set - still nothing.
        </p>
        <p>
          I look back at the docs learn about docker-compose - looks like an interesting tool for managing processes in a similar way to the Proc file within Heroku - definitely something to note for future exploration.
        </p>
        <p>
          With frustration setting in, I roll back to the Dockerfile provided in the documentation. This uses alpine as is base and takes some time to upload, but eventually I'm able to confirm that I can at least run CMD on Heroku with that Dockerfile. Whilst I'd love to understand what is wrong different between Continuum's image and the alpine image (other than the whole OS), my focus on getting my proof-of-concept up and running on Heroku, so I change tactic and update my Dockerfile derive FROM the alpine base image.
        </p>
        <p>
          After a little more iteration, I eventually manage to use alpine as the base for my webapp's image (including installing ca-certificates to prevent urllib from raising a CERTIFICATE_VERIFY_FAILED exception). I push the image to heroku, and define the DROPBOX_TOKEN environment variable that my code expects in the heroku web portal, but alas there is a problem with the FUSE mount:
        </p>
        <div class="highlight">
          <pre>
<span></span>2017-02-07T14:36:06.997268+00:00 app[web.1]: Starting FUSE...
2017-02-07T14:36:06.997269+00:00 app[web.1]: [ERROR] Failed to start FUSE... (Traceback (most recent call last):
2017-02-07T14:36:06.997270+00:00 app[web.1]:   File "ff4d/ff4d.py", line 812, in &lt;module&gt;
2017-02-07T14:36:06.997271+00:00 app[web.1]:     FUSE(Dropbox(ar), mountpoint, foreground=args.background, debug=debug_fuse, sync_read=True, allow_other=allow_other, allow_root=allow_root)
2017-02-07T14:36:06.997271+00:00 app[web.1]:   File "/opt/webapp/ff4d/fuse.py", line 405, in __init__
2017-02-07T14:36:06.997272+00:00 app[web.1]:     raise RuntimeError(err)
2017-02-07T14:36:06.997273+00:00 app[web.1]: RuntimeError: 1
</pre>
        </div>
        <p>
          In addition, there is a message in the log along the lines of:
        </p>
        <div class="highlight">
          <pre>
<span></span><span class="n">fuse</span><span class="o">:</span> <span class="n">device</span> <span class="n">not</span> <span class="n">found</span><span class="o">,</span> <span class="k">try</span> <span class="s1">'modprobe fuse'</span> <span class="n">first</span>
</pre>
        </div>
        <p>
          It may be as I feared: Heroku doesn't currently support FUSE mounts.
        </p>
        <p>
          In order to get one final datapoint, I put together the equivalent Dockerfile for ubuntu rather than alpine. Unfortunately the results are the same.
        </p>
      </div>
      <hr>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      var disqus_shortname = "pelson";
      var disqus_identifier = "heroku_fuse_mount";

      (function() {
      var dsq = document.createElement("script");
      dsq.type = "text/javascript";
      dsq.async = true;
      dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
      (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
      })();
      </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- /END THE FEATURETTES -->
      <div class="clearfix"></div>
      <hr class="featurette-divider">
      <!-- FOOTER -->
      <footer>
        <p class="pull-right">
          <a href="#">Back to top</a>
        </p>
        <p>
          © 2017 Phil Elson · <a href="https://pelson.github.io#">About</a> · <a href="https://pelson.github.io#contact">Contact</a> · <a href="https://pelson.github.io/feeds/atom.xml"><i class="fa fa-fw fa-rss-square"></i>RSS</a>
        </p>
      </footer>
    </div><!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://pelson.github.io/theme/jquery.min.js">
    </script> 
    <script src="https://pelson.github.io/theme/bootstrap.min.js">
    </script> 
    <script src="https://pelson.github.io/theme/js/scroll.js">
    </script> 
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29774503-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
